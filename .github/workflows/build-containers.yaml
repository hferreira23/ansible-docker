---
name: build-containers

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  schedule:
    - cron: '0 4 * * 6'

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: hferreira/ansible-docker

jobs:
  prepare:
    name: Determine build context
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      should-push: ${{ steps.check.outputs.should-push }}
      ref: ${{ steps.check.outputs.ref }}
      version: ${{ steps.version.outputs.tag }}
      has-version: ${{ steps.version.outputs.has-version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if build should proceed
        id: check
        shell: bash
        run: |
          set -euo pipefail
          # Determine if we should build based on event type
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # For push events, check if it's a release-please commit by github-actions bot
            commit_message="${{ github.event.head_commit.message }}"
            commit_author="${{ github.event.head_commit.author.username }}"
            if [[ "$commit_author" == "github-actions[bot]" ]] && [[ "$commit_message" =~ ^chore\(main\):\ release ]]; then
              echo "should-build=true" >> "$GITHUB_OUTPUT"
              echo "should-push=true" >> "$GITHUB_OUTPUT"
              echo "ref=${{ github.sha }}" >> "$GITHUB_OUTPUT"
              echo "‚úÖ Release commit by github-actions[bot] detected, building and pushing from main branch"
            else
              echo "should-build=false" >> "$GITHUB_OUTPUT"
              echo "should-push=false" >> "$GITHUB_OUTPUT"
              echo "‚è≠Ô∏è  Not a release commit by github-actions[bot], skipping build"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For PRs, check if it's a fix: or feat: commit - build but don't push
            commit_message="${{ github.event.pull_request.title }}"
            if [[ "$commit_message" =~ ^(fix|feat): ]]; then
              echo "should-build=true" >> "$GITHUB_OUTPUT"
              echo "should-push=false" >> "$GITHUB_OUTPUT"
              echo "ref=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
              echo "‚úÖ Fix/feat PR detected, building without pushing"
            else
              echo "should-build=false" >> "$GITHUB_OUTPUT"
              echo "should-push=false" >> "$GITHUB_OUTPUT"
              echo "‚è≠Ô∏è  PR doesn't start with fix: or feat:, skipping build"
            fi
          elif [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # For schedule/manual triggers, use latest release
            latest_release=$(gh release view --json tagName --jq '.tagName' 2>/dev/null || echo "")
            if [[ -n "$latest_release" ]]; then
              echo "should-build=true" >> "$GITHUB_OUTPUT"
              echo "should-push=true" >> "$GITHUB_OUTPUT"
              echo "ref=$latest_release" >> "$GITHUB_OUTPUT"
              echo "‚úÖ Building and pushing from latest release: $latest_release"
            else
              echo "should-build=false" >> "$GITHUB_OUTPUT"
              echo "should-push=false" >> "$GITHUB_OUTPUT"
              echo "‚ùå No release found, skipping build"
            fi
          else
            echo "should-build=false" >> "$GITHUB_OUTPUT"
            echo "should-push=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Extract version from ref
        id: version
        shell: bash
        run: |
          set -euo pipefail
          ref="${{ steps.check.outputs.ref }}"
          # Check if ref looks like a version tag (starts with v or is a semver pattern)
          if [[ "$ref" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            version="${ref#v}"  # Remove leading 'v' if present
            echo "tag=$version" >> "$GITHUB_OUTPUT"
            echo "has-version=true" >> "$GITHUB_OUTPUT"
            echo "üì¶ Version tag detected: $version"
          else
            echo "has-version=false" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è  No version tag in ref"
          fi

  build-amd64:
    name: Build amd64 image
    needs: prepare
    if: needs.prepare.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    outputs:
      docker-image-amd: ${{ env.IMAGE_NAME }}:amd64
      ghcr-image-amd: ghcr.io/${{ github.repository }}:amd64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to dhi.io
        uses: docker/login-action@v3
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push (linux/amd64)
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          push: ${{ fromJSON(needs.prepare.outputs.should-push) }}
          tags: |
            ${{ env.IMAGE_NAME }}:amd64
            ghcr.io/${{ github.repository }}:amd64

  build-arm64:
    name: Build arm64 image
    needs: prepare
    if: needs.prepare.outputs.should-build == 'true'
    runs-on: ubuntu-24.04-arm
    outputs:
      docker-image-arm: ${{ env.IMAGE_NAME }}:arm64
      ghcr-image-arm: ghcr.io/${{ github.repository }}:arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to dhi.io
        uses: docker/login-action@v3
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push (linux/arm64)
        uses: docker/build-push-action@v6
        with:
          platforms: linux/arm64
          push: ${{ fromJSON(needs.prepare.outputs.should-push) }}
          tags: |
            ${{ env.IMAGE_NAME }}:arm64
            ghcr.io/${{ github.repository }}:arm64

  create-manifest:
    name: Create and push multi-arch manifests
    needs: [prepare, build-amd64, build-arm64]
    if: fromJSON(needs.prepare.outputs.should-push)
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx (for imagetools)
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifests (DockerHub + GHCR)
        shell: bash
        run: |
          set -euo pipefail
          # docker buildx imagetools create will assemble a manifest list from existing images
          version_tag=""
          if [[ "${{ needs.prepare.outputs.has-version }}" == "true" ]]; then
            version_tag="--tag ${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version }}"
          fi

          docker buildx imagetools create --tag "${{ env.IMAGE_NAME }}:latest" \
            ${version_tag} \
            "${{ env.IMAGE_NAME }}:amd64" \
            "${{ env.IMAGE_NAME }}:arm64"

          version_tag_ghcr=""
          if [[ "${{ needs.prepare.outputs.has-version }}" == "true" ]]; then
            version_tag_ghcr="--tag ghcr.io/${{ github.repository }}:${{ needs.prepare.outputs.version }}"
          fi

          docker buildx imagetools create --tag "ghcr.io/${{ github.repository }}:latest" \
            ${version_tag_ghcr} \
            "ghcr.io/${{ github.repository }}:amd64" \
            "ghcr.io/${{ github.repository }}:arm64"
